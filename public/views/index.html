<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="../stylesheets/style.css" />

  <title>Todoアプリ</title>
</head>
<body>
  <div class="container">
    <!-- Content here -->
  </div>

  <h1>Todoアプリ</h1>
  <div class="create-b">
    <!-- 今日までのタスクのみ表示-->
    <input type="checkbox" class="btn-check today" id="btn-check-2"  autocomplete="off">
    <label class="btn btn-danger" for="btn-check-2">今日までのタスク</label>
  <div class="todaytask">
    <button
    type="button"
    class="btn btn-primary "
    data-toggle="modal"
    data-target="#exampleModal"
  >
    + タスクを追加
  </button>

  </div>
</div>
  <!-- Modal -->
  <div
    class="modal fade"
    id="exampleModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">タスク登録</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <script src="../javascripts/index.js"></script>
        <!-- アラートの表示内容-->
        <div class="modal-body">
          <form id="create-form"  method="POST" >
            <div class="form-group" >
              <label for="">タスク</label>
              <input class="form-control" type="text" name="taskName" /><br />
            </div>
            <div  class="form-group">
              <label for="">期限</label>
              <input class="form-control" type="text" name="deadline"/><br />
            </div>
            <div  class="form-group">
              <label for="">カテゴリー</label>
              <select class="custom-select" name="category">
                <option value="1" selected>生活</option>
                <option value="2">勉強</option>
                <option value="3">仕事</option>
                <option value="4">趣味</option>
              </select>
            </div>
          </form>
          <div  class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              キャンセル
            </button>
            <button id="create-task" type="button" class="btn btn-primary" >登録</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ここからタスクのリストに代わっていく-->
  <div class="row">
        <ul id="task-contents">
        </ul>
    </div>
</div>
  <!--          ここから更新のモーダル-->
  <div
    class="modal fade"
    id="exampleModal2"
    tabindex="-1"
    role="dialog"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">タスクの更新</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="update-form">
            <input type="hidden" name=”id”>
            <div class="form-group">
              <label for="">タスク</label>
              <input class="form-control" name="task" type="text" /><br />
            </div>
            <div class="form-group">
              <label for="">期限</label>
              <input class="form-control" type="text" name="deadline"><br />
            </div>
            <div class="form-group">
              <label for="">カテゴリー</label>
              <select class="custom-select " name="category">
                <option value="1" selected>勉強</option>
                <option value="2">Two</option>
                <option value="3">Three</option>
              </select>
            </div>
            
              <div class="form-group">
              <label for="">ステータス</label>
              <select class="custom-select " name="status">
                <option value="1" selected>進行中</option>
                <option value="2">一時停止</option>
                <option value="3">やめた</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-dismiss="modal"
          >
            キャンセル
          </button>
          <button id="update-task" type="button" class="btn btn-primary">更新</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ここから削除のモーダル-->
 
  <!-- Optional JavaScript -->

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->

  <script
    src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"
  ></script>
  <script>
    //問題1
    $("#create-task").on("click", async function(){
      //
      const requestData = {
        taskName: $("#create-form input[name=taskName]").val(),
        deadline: $("#create-form input[name=deadline]").val(),
        category: $("#create-form select[name=category]").val(),
      };
      const response = await httpPost(
        "//" + window.location.host + "/api/tasks",requestData
      );
      
      
      window.location.reload();
    })
  </script>
  <script>
    //問題2
    $(async function () {
      //jsonを叩いている

      
      const data = await httpGet("//" + window.location.host + "/api/items");
        
        let change = $('input[type=checkbox]').prop('checked')
        console.log(change);
        const today = new Date();
        const toyear = today.getFullYear();
        const tomonth = today.getMonth() + 1;
        const todate = today.getDate();

        let kyou = toyear + "-" + tomonth + "-" + todate;

        const list = data.map((item) => {
          //日付フォーマットの指定
        const now = new Date(item.deadline);
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        let line = year + "-" + month + "-" + date;
        let category_id = "";
        //カテゴリの種類によってリストに色をつける
        //console.log(item.category_id);
        switch(item.category_id){
          case 1:
          category_id = "a";
          break;
          case 2:
          category_id = "b";
          break;
          case 3:
          category_id = "c";
          break;
          case 4:
          category_id = "d";
          break;
          default:
            console.log("不正な値です。");
          }
          //console.log(date1)
          //タスクの期限が切れているものに警告
          console.log(kyou)
          console.log(line)
          if(today > now ){
            return  `<li> 
                <span class="${category_id}" ></span>
                <div class="col-sm-8 task">
                <span style="font-size: 23px;"><b>${item.task_name}</b></span>
                <span style="font-size: 14px;">期限が切れてます。</span>
                <span style="font-size: 17px;">${year}+"年"+${month}+"月"+${date}+ "日"</span>
              </div>
                <button
                  data-id=${item.id}
                    type="button"
                    class="btn btn-outline-primary col-sm-1 update-button"
                    data-toggle="modal"
                    data-target="#exampleModal2"
                  >
                    更新
                  </button>
                <button
                    
                    data-task=${item.task_name}
                    data-id=${item.id}
                    type="button"
                    class="btn btn-outline-danger col-sm-1 delete-button"
                    data-toggle="modal"
                    data-target="#exampleModal3"
                  >
                    削除
                  </button>
                </li>`;
          }else {
            return  `<li> 
                <span class="${category_id}" ></span>
                <div class="col-sm-8 task">
                <span style="font-size: 23px;"><b>${item.task_name}</b></span>
                <span style="font-size: 17px;">${year}年${month}月${date}日</span>
              </div>
                <button
                  data-id=${item.id}
                    type="button"
                    class="btn btn-outline-primary col-sm-1 update-button"
                    data-toggle="modal"
                    data-target="#exampleModal2"
                  >
                    更新
                  </button>
                <button
                    
                    data-task=${item.task_name}
                    data-id=${item.id}
                    type="button"
                    class="btn btn-outline-danger col-sm-1 delete-button"
                    data-toggle="modal"
                    data-target="#exampleModal3"
                  >
                    削除
                  </button>
                </li>`;
          }

        
      });
      $("ul#task-contents").append(list);
    });
  </script>
  <script>
    $(document).on("click", ".update-button", async function (){
      const id = $(this).data("id");

      const response = await httpGet("//" + window.location.host + `/api/get/${id}`);
      //ここが出力できない
      //console.log(response);
      //日付
      const date = new Date(response[0].deadline);
      const year = date.getFullYear();
      const month = ("0" + (date.getMonth() + 1)).slice(-2);
      const day = ("0" + date.getDate()).slice(-2);
      const deadlineVal = `${year}/${month}/${day}`;
      //初期値をセット
      //$("#update-form input[name=id]").val(response[0].id);
      //console.log($("#update-form input[name=id]").val());
      $("#update-form input[name=task]").val(response[0].task_name);
      //console.log($("#update-form input[name=task]").val());
      $("#update-form input[name=deadline]").val(deadlineVal);
      //console.log($("#update-form input[name=deadline]").val());
      $("#update-form select[name=category]").val(response[0].category_id);
      //console.log($("#update-form select[name=category]").val());
      $("#update-form select[name=status]").val(response[0].task_status);
     // console.log($("#update-form select[name=status]").val());
      

      $("#update-task").on("click", async function (){

          //console.log($("#update-form input[name=id]").val())
        const requestData = {
        task: $("#update-form input[name=task]").val(),
        deadline: $("#update-form input[name=deadline]").val(),
        category:  $("#update-form select[name=category]").val(),
        status: $("#update-form select[name=status]").val(),
      };
      const response = await httpUpdate("//" + window.location.host + `/api/update/${id}`, requestData);
      "window.location.reload();"
    });
    });
  </script>
  <script>
    $(document).on("click", ".delete-button", async function(){
      const task = $(this).data("task");
      if(confirm(`下記の内容を消去します\n ${task}`)){
        const id = $(this).data("id");
        const response = await httpDelete(
          "//" + window.location.host + `/api/delete/${id}`
        );
      }
      window.location.reload();
    })
  </script>
  <script>
    //今日のみのタスク表示する実装
    $(".today").change(async function(){
      console.log($(".today").prop("checked"))
      if(($(".today").prop("checked")) == true){
        $("#task-contents").empty();
        const data = await httpGet("//" + window.location.host + "/api/todayitem");
        const list = data.map((item) => {
        const now = new Date(item.deadline);
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();

        // タグの色付けの機能実装
        let category_id = "";
        switch(item.category_id){
          case 1:
          category_id = "a";
          break;
          case 2:
          category_id = "b";
          break;
          case 3:
          category_id = "c";
          break;
          case 4:
          category_id = "d";
          break;
          default:
            console.log("不正な値です。");
          }
          return  `<li> 
                <span class="${category_id}" ></span>
                <div class="col-sm-8 task">
                <span style="font-size: 23px;"><b>${item.task_name}</b></span>
                <span style="font-size: 17px;">${year}/${month}/${date}</span>
              </div>
                <button
                  data-id=${item.id}
                    type="button"
                    class="btn btn-outline-primary col-sm-1 update-button"
                    data-toggle="modal"
                    data-target="#exampleModal2"
                  >
                    更新
                  </button>
                <button
                    
                    data-task=${item.task_name}
                    data-id=${item.id}
                    type="button"
                    class="btn btn-outline-danger col-sm-1 delete-button"
                    data-toggle="modal"
                    data-target="#exampleModal3"
                  >
                    削除
                  </button>
                </li>`;
      });
      $("ul#task-contents").append(list);
      }
    });
  </script>
</body>
</html>
